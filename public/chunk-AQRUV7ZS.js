import{b as G,d as z,f as B,g as L,j as R,k as q,l as H,m as Q,o as $,p as J,q as u}from"./chunk-BE4YXLS7.js";import"./chunk-LJ5XHLMQ.js";import{m as V}from"./chunk-U4Q7EWK3.js";import{Ab as N,Bb as v,Da as y,Ga as o,Hb as T,Jb as A,La as w,P as C,Ra as M,Tb as D,U as b,V as d,Wa as S,ba as _,ca as x,cb as p,gb as j,hb as P,ib as O,jb as n,kb as i,lb as g,mb as U,qb as F,ra as h,rb as f,vb as E,wb as I,xb as k,zb as c}from"./chunk-5R74MMIU.js";import{h as m}from"./chunk-FK42CRUA.js";var l=class r{constructor(t){this.userService=t;this.supabase=J,this.listenForNewMessages()}supabase;savedChat=h([]);chatMessage(t,e){return m(this,null,function*(){try{let{error:a}=yield this.supabase.from("chat").insert({text:t,editable:!1,sender:e});a&&alert(a.message)}catch(a){alert(a)}})}listChat(){return m(this,null,function*(){let{data:t,error:e}=yield this.supabase.from("chat").select("*,Usuarios(*)").order("created_at",{ascending:!0});return e&&alert(e.message),t})}deleteChat(t){return m(this,null,function*(){return yield this.supabase.from("chat").delete().eq("id",t)})}setChatHistory(t){this.savedChat.set(t)}addNewMessage(t){let e=this.savedChat();this.savedChat.set([...e,t])}listenForNewMessages(){this.supabase.channel("chat_channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat"},t=>m(this,null,function*(){let e=t.new,{data:a,error:s}=yield this.supabase.from("Usuarios").select("*").eq("id",e.sender).single();!s&&a&&(e.Usuarios=a),this.addNewMessage(e)})).subscribe()}static \u0275fac=function(e){return new(e||r)(b(u))};static \u0275prov=C({token:r,factory:r.\u0275fac,providedIn:"root"})};var Y=["chatContainer"],Z=(r,t)=>t.id;function ee(r,t){if(r&1&&g(0,"img",15),r&2){let e=f().$implicit,a=f();p("src",a.getAvatarUrl(e.Usuarios==null?null:e.Usuarios.avatarUrl),y)}}function te(r,t){r&1&&(n(0,"div",16),c(1,"?"),i())}function ae(r,t){if(r&1&&(n(0,"div",7)(1,"div",14),S(2,ee,1,1,"img",15)(3,te,2,0,"div",16),n(4,"div",17),c(5),T(6,"date"),i()(),n(7,"div",18)(8,"div",19),c(9),i(),n(10,"div",20),c(11),i()()()),r&2){let e=t.$implicit;o(2),j(!(e==null||e.Usuarios==null)&&e.Usuarios.avatarUrl?2:3),o(3),v(" ",A(6,4,e==null?null:e.created_at,"M/d/yy, h:mm a")," "),o(4),v(" ",(e==null||e.Usuarios==null?null:e.Usuarios.nombre)||"Usuario desconocido"," "),o(2),N(e==null?null:e.text)}}function re(r,t){r&1&&(n(0,"div",8),c(1,"No hay mensajes a\xFAn."),i())}var K=class r{constructor(t){this.chatService=t;this.chatForm=this.fb.group({chat_message:["",z.required]}),this.onListChat(),D(()=>{let e=this.chatService.savedChat();this.chats.set(e),setTimeout(()=>this.scrollToBottom(),100)})}auth=d(u);chat_service=d(l);fb=d(Q);chats=h([]);chatContainer;chatForm;scrollToBottom(){try{this.chatContainer.nativeElement.scrollTop=this.chatContainer.nativeElement.scrollHeight}catch(t){console.error("Error al hacer scroll:",t)}}getAvatarUrl(t){return t?this.auth.getAvatarUrl(t):"ruta/al/avatar/default.png"}onSubmit(){let t=this.chatForm.value.chat_message,e=this.auth.getCurrentUser();if(!e||!e.id){alert("Usuario no identificado");return}this.chat_service.chatMessage(t,e.id).then(()=>{this.chatForm.reset()}).catch(a=>{alert(a.message)})}onListChat(){this.chat_service.listChat().then(t=>{t!==null&&this.chat_service.setChatHistory(t)}).catch(t=>{alert(t.message)})}static \u0275fac=function(e){return new(e||r)(w(l))};static \u0275cmp=M({type:r,selectors:[["friki-club-chat"]],viewQuery:function(e,a){if(e&1&&E(Y,5),e&2){let s;I(s=k())&&(a.chatContainer=s.first)}},decls:17,vars:3,consts:[["chatContainer",""],[1,"chat-fondo"],[1,"chat-container"],[1,"chat-titulo"],[1,"chat-card"],[1,"chat-mensajes"],[1,"chat-mensajes-contenedor"],[1,"mensaje-item"],[1,"mensaje-vacio"],[3,"ngSubmit","formGroup"],[1,"chat-input-contenedor"],[1,"input-group"],["formControlName","chat_message","type","text","placeholder","Escrib\xED tu mensaje...",1,"chat-input"],[1,"chat-boton-enviar",3,"disabled"],[1,"mensaje-avatar"],["alt","Avatar",1,"avatar-img",3,"src"],[1,"avatar-placeholder"],[1,"mensaje-hora"],[1,"mensaje-cuerpo"],[1,"mensaje-nombre"],[1,"mensaje-texto"]],template:function(e,a){if(e&1){let s=U();n(0,"main",1)(1,"div",2)(2,"h1",3),c(3,"CHAT GLOBAL"),i(),n(4,"div",4)(5,"div",5,0)(7,"div",6),P(8,ae,12,7,"div",7,Z,!1,re,2,0,"div",8),i()(),n(11,"form",9),F("ngSubmit",function(){return _(s),x(a.onSubmit())}),n(12,"div",10)(13,"div",11),g(14,"input",12),n(15,"button",13),c(16," Enviar "),i()()()()()()()}e&2&&(o(8),O(a.chats()),o(3),p("formGroup",a.chatForm),o(4),p("disabled",!a.chatForm.valid))},dependencies:[$,R,G,B,L,q,H,V],styles:["html[_ngcontent-%COMP%], body[_ngcontent-%COMP%]{margin:0;padding:0;height:100%;overflow:hidden}.chat-fondo[_ngcontent-%COMP%]{background-color:#121212;color:#fff;width:100%;height:100vh;display:flex;justify-content:center;align-items:start;padding-top:2rem;background:#000;--gap: 5em;--line: 1px;--color: rgba(255, 255, 255, .2);background-image:linear-gradient(-90deg,transparent calc(var(--gap) - var(--line)),var(--color) calc(var(--gap) - var(--line) + 1px),var(--color) var(--gap)),linear-gradient(0deg,transparent calc(var(--gap) - var(--line)),var(--color) calc(var(--gap) - var(--line) + 1px),var(--color) var(--gap));background-size:var(--gap) var(--gap)}.chat-container[_ngcontent-%COMP%]{width:100%;max-width:900px;padding:1rem}.chat-titulo[_ngcontent-%COMP%]{text-align:center;font-size:2.5rem;font-weight:700;margin-bottom:1rem;color:#fff;font-family:SuperDream}.chat-card[_ngcontent-%COMP%]{background-color:#1e1e1e;border-radius:.5rem;overflow:hidden;display:flex;flex-direction:column;height:80vh}.chat-mensajes[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:1rem}.chat-mensajes-contenedor[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem}.mensaje-item[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:1rem}.mensaje-avatar[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;width:60px}.avatar-img[_ngcontent-%COMP%]{width:48px;height:48px;border-radius:50%;object-fit:cover}.avatar-placeholder[_ngcontent-%COMP%]{width:48px;height:48px;background-color:#444;color:#fff;border-radius:50%;text-align:center;line-height:48px;font-size:1.2rem}.mensaje-hora[_ngcontent-%COMP%]{font-size:.75rem;color:#fff;margin-top:.25rem}.mensaje-cuerpo[_ngcontent-%COMP%]{background-color:#333;border-radius:.5rem;padding:.75rem 1rem;max-width:80%}.mensaje-nombre[_ngcontent-%COMP%]{font-weight:700;margin-bottom:.25rem;color:#fff}.mensaje-texto[_ngcontent-%COMP%]{color:#fff;word-wrap:break-word}.mensaje-vacio[_ngcontent-%COMP%]{text-align:center;color:#aaa;margin-top:2rem}.chat-input-contenedor[_ngcontent-%COMP%]{padding:1rem;background-color:#1e1e1e;border-top:1px solid #444}.chat-input[_ngcontent-%COMP%]{background-color:#2c2c2c;color:#fff;border:none;flex-grow:1;padding:.75rem 1rem;border-radius:.375rem 0 0 .375rem}.chat-input[_ngcontent-%COMP%]::placeholder{color:#bbb}.chat-boton-enviar[_ngcontent-%COMP%]{background-color:#007bff;color:#fff;border:none;padding:0 1rem;border-radius:0 .375rem .375rem 0;transition:background-color .3s}.chat-boton-enviar[_ngcontent-%COMP%]:hover{background-color:#0056b3}.input-group[_ngcontent-%COMP%]{display:flex}"]})};export{K as ChatComponent};
