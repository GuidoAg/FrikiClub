import{a as e}from"./chunk-37WAIENX.js";import{Q as f,g}from"./chunk-AWTQUO7P.js";import{h as i}from"./chunk-FK42CRUA.js";var b=class l{userDataSubject=new g(null);userData$=this.userDataSubject.asObservable();loadPromise=null;tempUserData=null;constructor(){e.auth.getUser().then(r=>{r.data?.user?this.loadUserData():this.userDataSubject.next(null)})}getCurrentUser(){return this.userDataSubject.getValue()}registerUser(r,t,s,a,c,o){return i(this,null,function*(){let{data:n,error:u}=yield e.auth.signUp({email:s,password:a});return n.user?.identities?.length===0?{success:!1,error:"Este correo ya est\xE1 registrado. Por favor, usa otro."}:u||!n.user?{success:!1,error:u?.message||"No se pudo registrar el usuario."}:(this.tempUserData={name:r,age:t,avatarFile:c,isAdmin:o},{success:!0})})}loadUserData(){return i(this,null,function*(){if(this.loadPromise)return this.loadPromise;this.loadPromise=i(this,null,function*(){let{data:r,error:t}=yield e.auth.getUser();if(t||!r.user){this.userDataSubject.next(null);return}let s=r.user.id;try{let{data:a,error:c}=yield e.from("Usuarios").select("*").eq("authId",s).single();if(c||!a)if(console.log("Usuario no encontrado en la tabla. Insertando datos..."),this.tempUserData){let{avatarFile:o,name:n,age:u,isAdmin:p}=this.tempUserData,m="";if(o){m=`avatarUsuarios/${`${s}_${Date.now()}_${o.name}`}`;let{error:h}=yield e.storage.from("imagenes").upload(m,o,{cacheControl:"3600",upsert:!1});if(h){console.error("Error al subir avatar:",h.message),this.userDataSubject.next(null);return}}let{data:U,error:d}=yield e.from("Usuarios").insert([{authId:s,nombre:n||r.user.email,edad:u||0,avatarUrl:m,admin:p}]).select().single();if(d){console.error("Error al insertar datos del usuario:",d.message),this.userDataSubject.next(null);return}this.userDataSubject.next(U)}else console.error("No hay datos temporales del usuario para insertar."),this.userDataSubject.next(null);else this.userDataSubject.next(a)}catch(a){console.error("Error al cargar los datos del usuario:",a),this.userDataSubject.next(null)}});try{yield this.loadPromise}finally{this.loadPromise=null}})}logout(){return i(this,null,function*(){yield e.auth.signOut(),this.userDataSubject.next(null),this.loadPromise=null})}getAvatarUrl(r){return e.storage.from("imagenes").getPublicUrl(r).data.publicUrl}static \u0275fac=function(t){return new(t||l)};static \u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})};export{b as a};
