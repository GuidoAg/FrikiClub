import{a as X,b as u}from"./chunk-OLG4LXMN.js";import"./chunk-LJ5XHLMQ.js";import{b as R,d as C,f as L,g as z,j as B,m as H,n as q,o as Q,q as $}from"./chunk-7YSXQOLL.js";import{n as V}from"./chunk-YMF7KUPX.js";import{Ab as c,Bb as N,Cb as v,Ea as S,Ha as s,Lb as A,Ma as y,Nb as D,Q as b,Sa as w,V as _,W as d,Xa as j,Zb as G,ca as x,da as M,db as p,hb as E,ib as P,jb as U,kb as n,lb as o,mb as g,nb as O,rb as F,sa as h,sb as f,wb as T,xb as I,yb as k}from"./chunk-AWTQUO7P.js";import{h as m}from"./chunk-FK42CRUA.js";var l=class r{constructor(t){this.userService=t;this.supabase=X,this.listenForNewMessages()}supabase;savedChat=h([]);chatMessage(t,e){return m(this,null,function*(){try{let{error:a}=yield this.supabase.from("chat").insert({text:t,editable:!1,sender:e});a&&alert(a.message)}catch(a){alert(a)}})}listChat(){return m(this,null,function*(){let{data:t,error:e}=yield this.supabase.from("chat").select("*,Usuarios(*)").order("created_at",{ascending:!0});return e&&alert(e.message),t})}deleteChat(t){return m(this,null,function*(){return yield this.supabase.from("chat").delete().eq("id",t)})}setChatHistory(t){this.savedChat.set(t)}addNewMessage(t){let e=this.savedChat();this.savedChat.set([...e,t])}listenForNewMessages(){this.supabase.channel("chat_channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat"},t=>m(this,null,function*(){let e=t.new,{data:a,error:i}=yield this.supabase.from("Usuarios").select("*").eq("id",e.sender).single();!i&&a&&(e.Usuarios=a),this.addNewMessage(e)})).subscribe()}static \u0275fac=function(e){return new(e||r)(_(u))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};var Y=["chatContainer"],Z=(r,t)=>t.id;function ee(r,t){if(r&1&&g(0,"img",15),r&2){let e=f().$implicit,a=f();p("src",a.getAvatarUrl(e.Usuarios==null?null:e.Usuarios.avatarUrl),S)}}function te(r,t){r&1&&(n(0,"div",16),c(1,"?"),o())}function ae(r,t){if(r&1&&(n(0,"div",7)(1,"div",14),j(2,ee,1,1,"img",15)(3,te,2,0,"div",16),n(4,"div",17),c(5),A(6,"date"),o()(),n(7,"div",18)(8,"div",19),c(9),o(),n(10,"div",20),c(11),o()()()),r&2){let e=t.$implicit;s(2),E(!(e==null||e.Usuarios==null)&&e.Usuarios.avatarUrl?2:3),s(3),v(" ",D(6,4,e==null?null:e.created_at,"M/d/yy, h:mm a")," "),s(4),v(" ",(e==null||e.Usuarios==null?null:e.Usuarios.nombre)||"Usuario desconocido"," "),s(2),N(e==null?null:e.text)}}function re(r,t){r&1&&(n(0,"div",8),c(1,"No hay mensajes a\xFAn."),o())}var J=class r{constructor(t){this.chatService=t;this.chatForm=this.fb.group({chat_message:["",[C.required,C.maxLength(300)]]}),this.onListChat(),G(()=>{let e=this.chatService.savedChat();this.chats.set(e),setTimeout(()=>this.scrollToBottom(),100)})}auth=d(u);chat_service=d(l);fb=d(Q);messageTimestamps=[];MAX_MESSAGES_PER_MINUTE=5;chats=h([]);chatContainer;chatForm;onSubmit(){let t=this.chatForm.value.chat_message?.trim(),e=this.auth.getCurrentUser();if(!e||!e.id){alert("Usuario no identificado");return}if(!t)return;let a=Date.now();if(this.messageTimestamps=this.messageTimestamps.filter(i=>a-i<6e4),this.messageTimestamps.length>=this.MAX_MESSAGES_PER_MINUTE){alert("Has enviado demasiados mensajes en poco tiempo. Espera unos segundos.");return}this.messageTimestamps.push(a),this.chat_service.chatMessage(t,e.id).then(()=>{this.chatForm.reset()}).catch(i=>{alert(i.message)})}scrollToBottom(){try{this.chatContainer.nativeElement.scrollTop=this.chatContainer.nativeElement.scrollHeight}catch(t){console.error("Error al hacer scroll:",t)}}getAvatarUrl(t){return t?this.auth.getAvatarUrl(t):"ruta/al/avatar/default.png"}onListChat(){this.chat_service.listChat().then(t=>{t!==null&&this.chat_service.setChatHistory(t)}).catch(t=>{alert(t.message)})}static \u0275fac=function(e){return new(e||r)(y(l))};static \u0275cmp=w({type:r,selectors:[["friki-club-chat"]],viewQuery:function(e,a){if(e&1&&T(Y,5),e&2){let i;I(i=k())&&(a.chatContainer=i.first)}},decls:17,vars:3,consts:[["chatContainer",""],[1,"chat-fondo"],[1,"chat-container"],[1,"chat-titulo"],[1,"chat-card"],[1,"chat-mensajes"],[1,"chat-mensajes-contenedor"],[1,"mensaje-item"],[1,"mensaje-vacio"],[3,"ngSubmit","formGroup"],[1,"chat-input-contenedor"],[1,"input-group"],["formControlName","chat_message","type","text","placeholder","Escrib\xED tu mensaje...",1,"chat-input"],[1,"chat-boton-enviar",3,"disabled"],[1,"mensaje-avatar"],["alt","Avatar",1,"avatar-img",3,"src"],[1,"avatar-placeholder"],[1,"mensaje-hora"],[1,"mensaje-cuerpo"],[1,"mensaje-nombre"],[1,"mensaje-texto"]],template:function(e,a){if(e&1){let i=O();n(0,"main",1)(1,"div",2)(2,"h1",3),c(3,"CHAT GLOBAL"),o(),n(4,"div",4)(5,"div",5,0)(7,"div",6),P(8,ae,12,7,"div",7,Z,!1,re,2,0,"div",8),o()(),n(11,"form",9),F("ngSubmit",function(){return x(i),M(a.onSubmit())}),n(12,"div",10)(13,"div",11),g(14,"input",12),n(15,"button",13),c(16," Enviar "),o()()()()()()()}e&2&&(s(8),U(a.chats()),s(3),p("formGroup",a.chatForm),s(4),p("disabled",!a.chatForm.valid))},dependencies:[$,B,R,L,z,H,q,V],styles:["html[_ngcontent-%COMP%], body[_ngcontent-%COMP%]{margin:0;padding:0;height:100%;overflow:hidden}.chat-fondo[_ngcontent-%COMP%]{background-color:#121212;color:#fff;width:100%;height:100vh;display:flex;justify-content:center;align-items:start;padding-top:2rem;background:#000;--gap: 5em;--line: 1px;--color: rgba(255, 255, 255, .2);background-image:linear-gradient(-90deg,transparent calc(var(--gap) - var(--line)),var(--color) calc(var(--gap) - var(--line) + 1px),var(--color) var(--gap)),linear-gradient(0deg,transparent calc(var(--gap) - var(--line)),var(--color) calc(var(--gap) - var(--line) + 1px),var(--color) var(--gap));background-size:var(--gap) var(--gap)}.chat-container[_ngcontent-%COMP%]{width:100%;max-width:900px;padding:1rem}.chat-titulo[_ngcontent-%COMP%]{text-align:center;font-size:2.5rem;font-weight:700;margin-bottom:1rem;color:#fff;font-family:SuperDream}.chat-card[_ngcontent-%COMP%]{background-color:#1e1e1e;border-radius:.5rem;overflow:hidden;display:flex;flex-direction:column;height:80vh}.chat-mensajes[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:1rem}.chat-mensajes-contenedor[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem}.mensaje-item[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:1rem}.mensaje-avatar[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;width:60px}.avatar-img[_ngcontent-%COMP%]{width:48px;height:48px;border-radius:50%;object-fit:cover}.avatar-placeholder[_ngcontent-%COMP%]{width:48px;height:48px;background-color:#444;color:#fff;border-radius:50%;text-align:center;line-height:48px;font-size:1.2rem}.mensaje-hora[_ngcontent-%COMP%]{font-size:.75rem;color:#fff;margin-top:.25rem}.mensaje-cuerpo[_ngcontent-%COMP%]{background-color:#333;border-radius:.5rem;padding:.75rem 1rem;max-width:80%}.mensaje-nombre[_ngcontent-%COMP%]{font-weight:700;margin-bottom:.25rem;color:#fff}.mensaje-texto[_ngcontent-%COMP%]{color:#fff;word-wrap:break-word}.mensaje-vacio[_ngcontent-%COMP%]{text-align:center;color:#aaa;margin-top:2rem}.chat-input-contenedor[_ngcontent-%COMP%]{padding:1rem;background-color:#1e1e1e;border-top:1px solid #444}.chat-input[_ngcontent-%COMP%]{background-color:#2c2c2c;color:#fff;border:none;flex-grow:1;padding:.75rem 1rem;border-radius:.375rem 0 0 .375rem}.chat-input[_ngcontent-%COMP%]::placeholder{color:#bbb}.chat-boton-enviar[_ngcontent-%COMP%]{background-color:#007bff;color:#fff;border:none;padding:0 1rem;border-radius:0 .375rem .375rem 0;transition:background-color .3s}.chat-boton-enviar[_ngcontent-%COMP%]:hover{background-color:#0056b3}.input-group[_ngcontent-%COMP%]{display:flex}"]})};export{J as ChatComponent};
