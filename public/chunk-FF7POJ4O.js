import{a as e}from"./chunk-37WAIENX.js";import{Q as g,g as h}from"./chunk-AWTQUO7P.js";import{h as i}from"./chunk-FK42CRUA.js";var f=class n{userDataSubject=new h(null);userData$=this.userDataSubject.asObservable();loadPromise=null;tempUserData=null;constructor(){e.auth.getUser().then(r=>{r.data?.user?this.loadUserData():this.userDataSubject.next(null)})}getCurrentUser(){return this.userDataSubject.getValue()}registerUser(r,s,o,a,l){return i(this,null,function*(){let{data:t,error:u}=yield e.auth.signUp({email:o,password:a});return t.user?.identities?.length===0?{success:!1,error:"Este correo ya est\xE1 registrado. Por favor, usa otro."}:u||!t.user?{success:!1,error:u?.message||"No se pudo registrar el usuario."}:(this.tempUserData={name:r,age:s,avatarFile:l},{success:!0})})}loadUserData(){return i(this,null,function*(){if(this.loadPromise)return this.loadPromise;this.loadPromise=i(this,null,function*(){let{data:r,error:s}=yield e.auth.getUser();if(s||!r.user){this.userDataSubject.next(null);return}let o=r.user.id;try{let{data:a,error:l}=yield e.from("Usuarios").select("*").eq("authId",o).single();if(l||!a)if(console.log("Usuario no encontrado en la tabla. Insertando datos..."),this.tempUserData){let{avatarFile:t,name:u,age:b}=this.tempUserData,c="";if(t){c=`avatarUsuarios/${`${o}_${Date.now()}_${t.name}`}`;let{error:d}=yield e.storage.from("imagenes").upload(c,t,{cacheControl:"3600",upsert:!1});if(d){console.error("Error al subir avatar:",d.message),this.userDataSubject.next(null);return}}let{data:p,error:m}=yield e.from("Usuarios").insert([{authId:o,nombre:u||r.user.email,edad:b||0,avatarUrl:c}]).select().single();if(m){console.error("Error al insertar datos del usuario:",m.message),this.userDataSubject.next(null);return}this.userDataSubject.next(p)}else console.error("No hay datos temporales del usuario para insertar."),this.userDataSubject.next(null);else this.userDataSubject.next(a)}catch(a){console.error("Error al cargar los datos del usuario:",a),this.userDataSubject.next(null)}});try{yield this.loadPromise}finally{this.loadPromise=null}})}logout(){return i(this,null,function*(){yield e.auth.signOut(),this.userDataSubject.next(null),this.loadPromise=null})}getAvatarUrl(r){return e.storage.from("imagenes").getPublicUrl(r).data.publicUrl}static \u0275fac=function(s){return new(s||n)};static \u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})};export{f as a};
